<!-- app/templates/admin/role_form.html -->

{% extends "base.html" %}

{% block title %}{{ title }} - نظام إدارة المستشفى{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-shield-plus"></i> {{ title }}</h2>
        {% if role %}
        <p class="text-muted">تعديل الدور: <strong>{{ role.name }}</strong></p>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <!-- Basic Info -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">{{ form.name.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control") }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Permissions Section -->
                    <h5 class="mb-3"><i class="bi bi-key"></i> الصلاحيات</h5>
                    <p class="text-muted">حدد الصلاحيات التي يمتلكها هذا الدور</p>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>ملاحظة:</strong> يمكنك تحديد أو إلغاء تحديد جميع الصلاحيات في كل فئة بالنقر على اسم الفئة.
                    </div>
                    
                    <!-- Permissions by Category -->
                    {% for category, permissions in permissions_by_category.items() %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input category-checkbox" 
                                       id="category_{{ category }}" 
                                       data-category="{{ category }}">
                                <label class="form-check-label fw-bold" for="category_{{ category }}">
                                    <i class="bi bi-folder"></i> 
                                    {% if category == 'patients' %}إدارة المرضى
                                    {% elif category == 'appointments' %}إدارة المواعيد
                                    {% elif category == 'clinical' %}السجلات الطبية
                                    {% elif category == 'facility' %}إدارة الأسرّة والإدخالات
                                    {% elif category == 'billing' %}إدارة الفواتير
                                    {% elif category == 'users' %}إدارة المستخدمين
                                    {% elif category == 'reports' %}التقارير
                                    {% else %}{{ category }}{% endif %}
                                    <span class="badge bg-secondary ms-2">{{ permissions|length }}</span>
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for perm in permissions %}
                                    {% set field_name = 'perm_' ~ perm.id %}
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check">
                                            {# This now calls a properly BoundField with a .data attribute #}
                                            {{ form[field_name](class="form-check-input permission-checkbox") }}
                                            <label class="form-check-label" for="{{ field_name }}">
                                                {{ perm.name }}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('admin.roles_list') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-right"></i> إلغاء
                        </a>
                        {{ form.submit(class="btn btn-success btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Select/Deselect all permissions in a category
    document.querySelectorAll('.category-checkbox').forEach(categoryCheckbox => {
        const category = categoryCheckbox.dataset.category;
        const permissionCheckboxes = document.querySelectorAll(
            `.permission-checkbox[data-category="${category}"]`
        );
        
        // Set initial state based on permissions
        updateCategoryCheckbox(categoryCheckbox, permissionCheckboxes);
        
        // Toggle all permissions when category is clicked
        categoryCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            permissionCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });
        
        // Update category checkbox when individual permissions change
        permissionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateCategoryCheckbox(categoryCheckbox, permissionCheckboxes);
            });
        });
    });
    
    function updateCategoryCheckbox(categoryCheckbox, permissionCheckboxes) {
        const total = permissionCheckboxes.length;
        const checked = Array.from(permissionCheckboxes).filter(cb => cb.checked).length;
        
        if (checked === 0) {
            categoryCheckbox.checked = false;
            categoryCheckbox.indeterminate = false;
        } else if (checked === total) {
            categoryCheckbox.checked = true;
            categoryCheckbox.indeterminate = false;
        } else {
            categoryCheckbox.checked = false;
            categoryCheckbox.indeterminate = true;
        }
    }
</script>
{% endblock %}