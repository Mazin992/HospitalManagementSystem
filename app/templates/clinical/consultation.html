{% extends "base.html" %}

{% block title %}كشف طبي - {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="bi bi-clipboard2-pulse"></i> كشف طبي</h2>
    </div>
    <div class="col-md-4 text-start">
        <a href="{{ url_for('clinical.doctor_dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-right"></i> رجوع
        </a>
    </div>
</div>

<div class="row">
    <!-- Patient Info Card -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-person-circle"></i> معلومات المريض</h5>
            </div>
            <div class="card-body">
                <p><strong>الاسم:</strong><br>{{ patient.full_name }}</p>
                <p><strong>رقم الملف:</strong><br>{{ patient.file_number }}</p>
                <p><strong>الجنس:</strong><br>
                    {% if patient.gender == 'M' %}ذكر{% elif patient.gender == 'F' %}أنثى{% else %}غير محدد{% endif %}
                </p>
                {% if patient.dob %}
                <p><strong>العمر:</strong><br>{{ (date.today().year - patient.dob.year) }} سنة</p>
                {% endif %}
                {% if patient.phone %}
                <p><strong>الهاتف:</strong><br>{{ patient.phone }}</p>
                {% endif %}
                
                <hr>
                
                <p><strong>الموعد:</strong><br>{{ appointment.date_time.strftime('%Y-%m-%d %H:%M') }}</p>
                <p><strong>النوع:</strong><br>
                    {% if appointment.type == 'walk-in' %}
                        <span class="badge bg-warning">مراجعة طارئة</span>
                    {% else %}
                        <span class="badge bg-info">موعد محجوز</span>
                    {% endif %}
                </p>
                
                <div class="mt-3">
                    <a href="{{ url_for('clinical.patient_history', patient_id=patient.id) }}" 
                       class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-clock-history"></i> السجل الطبي الكامل
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Previous Visits Summary -->
        {% if previous_visits %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-journal-medical"></i> آخر الزيارات</h6>
            </div>
            <div class="card-body">
                {% for visit in previous_visits[:3] %}
                <div class="mb-3 pb-2 border-bottom">
                    <small class="text-muted">{{ visit.created_at.strftime('%Y-%m-%d') }}</small>
                    <p class="mb-0"><strong>التشخيص:</strong></p>
                    <small>{{ visit.diagnosis[:100] }}...</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Consultation Form -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-file-medical"></i> بيانات الكشف</h5>
            </div>
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <!-- Symptoms -->
                    <div class="mb-3">
                        {{ form.symptoms.label(class="form-label") }}
                        {{ form.symptoms(class="form-control" + (" is-invalid" if form.symptoms.errors else "")) }}
                        {% if form.symptoms.errors %}
                            <div class="invalid-feedback">{{ form.symptoms.errors[0] }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Diagnosis -->
                    <div class="mb-3">
                        {{ form.diagnosis.label(class="form-label") }}
                        {{ form.diagnosis(class="form-control" + (" is-invalid" if form.diagnosis.errors else "")) }}
                        {% if form.diagnosis.errors %}
                            <div class="invalid-feedback">{{ form.diagnosis.errors[0] }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Prescription -->
                    <div class="mb-3">
                        {{ form.prescription_text.label(class="form-label") }}
                        {{ form.prescription_text(class="form-control") }}
                    </div>
                    
                    <hr>
                    
                    <!-- Vitals Section -->
                    <h6 class="mb-3"><i class="bi bi-heart-pulse"></i> العلامات الحيوية (اختياري)</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.temperature.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.temperature(class="form-control") }}
                                <span class="input-group-text">°C</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ form.blood_pressure.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.blood_pressure(class="form-control") }}
                                <span class="input-group-text">mmHg</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.heart_rate.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.heart_rate(class="form-control") }}
                                <span class="input-group-text">bpm</span>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.weight.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.weight(class="form-control") }}
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.height.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.height(class="form-control") }}
                                <span class="input-group-text">cm</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control") }}
                    </div>
                    
                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-success btn-lg") }}
                        <a href="{{ url_for('clinical.doctor_dashboard') }}" class="btn btn-outline-secondary">
                            إلغاء
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}