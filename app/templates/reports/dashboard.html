{% extends "base.html" %}

{% block title %}لوحة التقارير والإحصائيات - نظام إدارة المستشفى{% endblock %}

{% block extra_css %}
<style>
    /* Custom dashboard styles */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .filter-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .stat-card .card-body {
        padding: 1.5rem;
    }

    .stat-icon {
        font-size: 3rem;
        opacity: 0.3;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .growth-badge {
        font-size: 0.85rem;
        padding: 0.4em 0.8em;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .chart-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 350px;
        padding: 1rem;
    }

    .table-card {
        background: white;
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-card .card-header {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    .period-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 0.6rem 1rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-apply {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 0.6rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }

    .btn-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2d3748;
        margin: 2rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid #667eea;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-2">
                <i class="bi bi-graph-up-arrow"></i> لوحة التقارير والإحصائيات
            </h2>
            <p class="mb-0 opacity-75">تحليل شامل لأداء المستشفى</p>
        </div>
        <div class="col-md-4 text-start">
            <div class="period-badge">
                <i class="bi bi-calendar3"></i> {{ period_desc }}
            </div>
        </div>
    </div>
</div>

<!-- Date Filter Section -->
<div class="filter-card">
    <form method="GET" id="filterForm">
        <div class="row g-3 align-items-end">
            <!-- Preset Range -->
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="bi bi-calendar-range"></i> {{ form.preset_range.label }}
                </label>
                {{ form.preset_range(class="form-select", id="presetRange") }}
            </div>

            <!-- Start Date (Always Visible) -->
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="bi bi-calendar-event"></i> {{ form.start_date.label }}
                </label>
                {{ form.start_date(class="form-control", id="startDate") }}
            </div>

            <!-- End Date (Always Visible) -->
            <div class="col-md-3">
                <label class="form-label fw-bold">
                    <i class="bi bi-calendar-check"></i> {{ form.end_date.label }}
                </label>
                {{ form.end_date(class="form-control", id="endDate") }}
            </div>

            <!-- Apply Button -->
            <div class="col-md-3">
                <button type="submit" class="btn btn-apply w-100">
                    <i class="bi bi-funnel"></i> تطبيق الفلتر
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Key Metrics Section -->
<h3 class="section-title">
    <i class="bi bi-speedometer2"></i> المؤشرات الرئيسية
</h3>

<div class="row mb-4">
    <!-- Revenue Card -->
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-start border-primary border-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stat-label mb-1">إيرادات الفترة</p>
                        <h3 class="stat-value text-primary">
                            {{ "{:,.0f}".format(stats.revenue.total) }}
                        </h3>
                        <small class="text-muted">جنيه سوداني</small>
                    </div>
                    <i class="bi bi-cash-coin stat-icon text-primary"></i>
                </div>
                <div class="mt-3">
                    {% if stats.revenue.growth >= 0 %}
                    <span class="growth-badge badge bg-success">
                        <i class="bi bi-arrow-up"></i> {{ stats.revenue.growth }}%
                    </span>
                    {% else %}
                    <span class="growth-badge badge bg-danger">
                        <i class="bi bi-arrow-down"></i> {{ stats.revenue.growth }}%
                    </span>
                    {% endif %}
                    <small class="text-muted ms-2">عن الفترة السابقة</small>
                </div>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-receipt"></i> {{ stats.revenue.invoice_count }} فاتورة
                </small>
            </div>
        </div>
    </div>

    <!-- Patients Card -->
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-start border-success border-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stat-label mb-1">إجمالي المرضى</p>
                        <h3 class="stat-value text-success">
                            {{ stats.patients.total }}
                        </h3>
                        <small class="text-muted">مريض مسجل</small>
                    </div>
                    <i class="bi bi-people stat-icon text-success"></i>
                </div>
                <div class="mt-3">
                    <span class="growth-badge badge bg-info">
                        <i class="bi bi-plus-circle"></i> {{ stats.patients.new_in_period }}
                    </span>
                    <small class="text-muted ms-2">مريض جديد في الفترة</small>
                </div>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-gender-male"></i> {{ stats.patients.by_gender.M }} ذكور
                    <i class="bi bi-gender-female ms-2"></i> {{ stats.patients.by_gender.F }} إناث
                </small>
            </div>
        </div>
    </div>

    <!-- Appointments Card -->
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-start border-info border-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stat-label mb-1">المواعيد</p>
                        <h3 class="stat-value text-info">
                            {{ stats.appointments.total }}
                        </h3>
                        <small class="text-muted">في الفترة</small>
                    </div>
                    <i class="bi bi-calendar-check stat-icon text-info"></i>
                </div>
                <div class="mt-3">
                    <span class="growth-badge badge bg-success">
                        <i class="bi bi-check-circle"></i> نسبة الإكمال: {{ stats.appointments.completion_rate }}%
                    </span>
                </div>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-check2-square"></i> {{ stats.appointments.by_status.completed }} مكتمل
                    <i class="bi bi-clock-history ms-2"></i> {{ stats.appointments.by_status.pending }} معلق
                </small>
            </div>
        </div>
    </div>

    <!-- Bed Occupancy Card -->
    <div class="col-md-3 mb-3">
        <div class="card stat-card border-start border-warning border-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="stat-label mb-1">إشغال الأسرّة</p>
                        <h3 class="stat-value text-warning">
                            {{ stats.bed_occupancy.occupancy_rate }}%
                        </h3>
                        <small class="text-muted">{{ stats.bed_occupancy.available }} متاح</small>
                    </div>
                    <i class="bi bi-hospital stat-icon text-warning"></i>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: {{ stats.bed_occupancy.occupancy_rate }}%"
                             aria-valuenow="{{ stats.bed_occupancy.occupancy_rate }}"
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>
                <hr>
                <small class="text-muted">
                    <i class="bi bi-hospital"></i> {{ stats.bed_occupancy.occupied }} مشغول
                    | {{ stats.bed_occupancy.total_beds }} إجمالي
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<h3 class="section-title">
    <i class="bi bi-bar-chart-line"></i> الاتجاهات والتحليلات
</h3>

<div class="row">
    <!-- Monthly Revenue Chart -->
    <div class="col-md-8 mb-4">
        <div class="chart-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> الإيرادات الشهرية (آخر 12 شهر)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Status Chart -->
    <div class="col-md-4 mb-4">
        <div class="chart-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i> حالة المواعيد
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="appointmentsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Registrations Chart -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="chart-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i> اتجاه تسجيل المرضى الجدد (آخر 12 شهر)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="patientsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tables Section -->
<h3 class="section-title">
    <i class="bi bi-table"></i> التفاصيل والبيانات
</h3>

<div class="row">
    <!-- Top Services Table -->
    <div class="col-md-6 mb-4">
        <div class="table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-star-fill text-warning"></i> أكثر الخدمات استخداماً
                </h5>
            </div>
            <div class="card-body">
                {% if stats.top_services %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>الخدمة</th>
                                <th class="text-center">عدد المرات</th>
                                <th class="text-end">الإيراد</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in stats.top_services[:10] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ service.service_name }}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ service.usage_count }}</span>
                                </td>
                                <td class="text-end text-success fw-bold">
                                    {{ "{:,.2f}".format(service.total_revenue) }} ج.س
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">لا توجد بيانات للفترة المحددة</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Appointments by Doctor Table -->
    <div class="col-md-6 mb-4">
        <div class="table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge text-primary"></i> المواعيد حسب الطبيب
                </h5>
            </div>
            <div class="card-body">
                {% if stats.appointments_by_doctor %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>الطبيب</th>
                                <th class="text-center">المجموع</th>
                                <th class="text-center">مكتمل</th>
                                <th class="text-center">معلق</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doctor in stats.appointments_by_doctor[:10] %}
                            <tr>
                                <td><strong>{{ doctor.doctor_name }}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ doctor.total }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{{ doctor.completed }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">{{ doctor.pending }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">لا توجد بيانات للفترة المحددة</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Additional Stats Row -->
<div class="row">
    <div class="col-md-12">
        <div class="card table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> معلومات إضافية
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="bi bi-hospital-fill text-info" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ stats.admissions.active_admissions }}</h4>
                            <p class="text-muted mb-0">إدخالات نشطة</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="bi bi-calendar-plus text-success" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ stats.admissions.total_in_period }}</h4>
                            <p class="text-muted mb-0">إدخالات في الفترة</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ stats.admissions.avg_stay_duration }}</h4>
                            <p class="text-muted mb-0">متوسط مدة الإقامة (أيام)</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <i class="bi bi-calendar3-range text-primary" style="font-size: 2rem;"></i>
                            <h4 class="mt-2">{{ stats.revenue.period_days }}</h4>
                            <p class="text-muted mb-0">عدد أيام الفترة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ============================================================================
// DATE FILTER HANDLING
// ============================================================================

const presetSelect = document.getElementById('presetRange');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');

// Handle preset change
presetSelect.addEventListener('change', function() {
    if (this.value !== 'custom') {
        // Calculate dates for preset and submit form
        document.getElementById('filterForm').submit();
    }
});

// Handle manual date change
startDateInput.addEventListener('change', function() {
    if (presetSelect.value !== 'custom') {
        presetSelect.value = 'custom';
    }
});

endDateInput.addEventListener('change', function() {
    if (presetSelect.value !== 'custom') {
        presetSelect.value = 'custom';
    }
});

// ============================================================================
// CHART.JS CONFIGURATION
// ============================================================================

Chart.defaults.font.family = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';

// Revenue Chart (Bar)
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(revenueCtx, {
    type: 'bar',
    data: {
        labels: {{ stats.revenue_by_month | map(attribute='month_name') | list | tojson }},
        datasets: [{
            label: 'الإيرادات (ج.س)',
            data: {{ stats.revenue_by_month | map(attribute='revenue') | list | tojson }},
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2,
            borderRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: { size: 12 },
                    padding: 15
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        return 'الإيرادات: ' + context.parsed.y.toLocaleString('ar-SD') + ' ج.س';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('ar-SD') + ' ج.س';
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Patients Trend Chart (Line)
const patientsCtx = document.getElementById('patientsChart').getContext('2d');
const patientsChart = new Chart(patientsCtx, {
    type: 'line',
    data: {
        labels: {{ stats.patients_by_month | map(attribute='month_name') | list | tojson }},
        datasets: [{
            label: 'مرضى جدد',
            data: {{ stats.patients_by_month | map(attribute='count') | list | tojson }},
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: { size: 12 },
                    padding: 15
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Appointments Status Chart (Doughnut)
const appointmentsCtx = document.getElementById('appointmentsChart').getContext('2d');
const appointmentsChart = new Chart(appointmentsCtx, {
    type: 'doughnut',
    data: {
        labels: ['معلق', 'مؤكد', 'مكتمل', 'ملغى', 'لم يحضر'],
        datasets: [{
            data: [
                {{ stats.appointments.by_status.pending }},
                {{ stats.appointments.by_status.confirmed }},
                {{ stats.appointments.by_status.completed }},
                {{ stats.appointments.by_status.cancelled }},
                {{ stats.appointments.by_status.no_show }}
            ],
            backgroundColor: [
                'rgba(255, 206, 86, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(201, 203, 207, 0.8)'
            ],
            borderColor: '#fff',
            borderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    font: { size: 11 },
                    padding: 10
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12
            }
        }
    }
});
</script>
{% endblock %}