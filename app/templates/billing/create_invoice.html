{% extends "base.html" %}

{% block title %}إنشاء فاتورة جديدة - نظام إدارة المستشفى{% endblock %}

{% block extra_css %}
<!-- Select2 CSS for Auto-Complete -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-receipt-cutoff"></i> إنشاء فاتورة جديدة</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="POST" novalidate id="invoiceForm">
                    {{ form.hidden_tag() }}

                    <!-- Patient Selection with Auto-Complete -->
                    <div class="mb-4">
                        {{ form.patient_id.label(class="form-label fw-bold") }}
                        {{ form.patient_id(class="form-select form-select-lg" + (" is-invalid" if form.patient_id.errors else ""), id="patientSelect") }}
                        {% if form.patient_id.errors %}
                            <div class="invalid-feedback">{{ form.patient_id.errors[0] }}</div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-search"></i> ابحث عن المريض بالاسم أو رقم الملف
                        </div>
                    </div>

                    <hr>

                    <!-- Services Section -->
                    <h5 class="mb-3"><i class="bi bi-list-ul"></i> الخدمات</h5>

                    <div id="servicesContainer">
                        <!-- Service items will be added here -->
                    </div>

                    <button type="button" class="btn btn-outline-primary mb-3" id="addServiceBtn">
                        <i class="bi bi-plus-circle"></i> إضافة خدمة
                    </button>

                    <hr>

                    <!-- Total -->
                    <div class="row mb-3">
                        <div class="col-md-8 text-start">
                            <h4>المجموع الكلي:</h4>
                        </div>
                        <div class="col-md-4 text-start">
                            <h3 class="text-primary"><span id="totalAmount">0.00</span> ج.س</h3>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control") }}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('billing.invoices_list') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-right"></i> إلغاء
                        </a>
                        {{ form.submit(class="btn btn-success btn-lg", id="submitBtn") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery (required for Select2) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const servicesData = {{ services_data|tojson }};
    let serviceCounter = 0;

    // Initialize Select2 for Patient Selection
    $(document).ready(function() {
        $('#patientSelect').select2({
            theme: 'bootstrap-5',
            dir: "rtl",
            placeholder: "ابحث عن المريض...",
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            language: {
                noResults: function() {
                    return "لا توجد نتائج";
                },
                searching: function() {
                    return "جاري البحث...";
                },
                inputTooShort: function() {
                    return "ابدأ الكتابة للبحث";
                }
            }
        });

        // Validate patient selection before allowing service addition
        $('#addServiceBtn').on('click', function() {
            const patientId = $('#patientSelect').val();
            if (!patientId || patientId == '0') {
                alert('يرجى اختيار المريض أولاً');
                $('#patientSelect').select2('open');
                return;
            }
            addServiceRow();
        });

        // Validate patient selection on form submit
        $('#invoiceForm').on('submit', function(e) {
            const patientId = $('#patientSelect').val();
            if (!patientId || patientId == '0') {
                e.preventDefault();
                alert('يرجى اختيار المريض');
                $('#patientSelect').select2('open');
                return false;
            }

            // Check if at least one service is added
            const serviceRows = document.querySelectorAll('.service-row');
            let hasValidService = false;
            serviceRows.forEach(row => {
                const select = row.querySelector('.service-select');
                if (select && select.value && select.value != '0') {
                    hasValidService = true;
                }
            });

            if (!hasValidService) {
                e.preventDefault();
                alert('يجب إضافة خدمة واحدة على الأقل');
                return false;
            }
        });
    });

    function addServiceRow() {
        const container = document.getElementById('servicesContainer');
        const row = document.createElement('div');
        row.className = 'row mb-3 service-row';
        row.id = `service-row-${serviceCounter}`;

        row.innerHTML = `
            <div class="col-md-6">
                <label class="form-label">الخدمة</label>
                <select name="services-${serviceCounter}-service_id" class="form-select service-select" data-index="${serviceCounter}">
                    <option value="0">اختر الخدمة</option>
                    ${servicesData.map(s => `<option value="${s.id}" data-cost="${s.cost}">${s.name} - ${s.cost.toFixed(2)} ج.س</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">الكمية</label>
                <input type="number" name="services-${serviceCounter}-quantity" class="form-control quantity-input"
                       value="1" min="1" max="100" data-index="${serviceCounter}">
            </div>
            <div class="col-md-2">
                <label class="form-label">المجموع</label>
                <input type="text" class="form-control item-total" id="item-total-${serviceCounter}" readonly value="0.00">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger w-100" onclick="removeServiceRow(${serviceCounter})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

        container.appendChild(row);
        serviceCounter++;

        // Add event listeners
        row.querySelector('.service-select').addEventListener('change', calculateTotal);
        row.querySelector('.quantity-input').addEventListener('input', calculateTotal);
    }

    function removeServiceRow(index) {
        const row = document.getElementById(`service-row-${index}`);
        if (row) {
            row.remove();
            calculateTotal();
        }
    }

    function calculateTotal() {
        let total = 0;

        document.querySelectorAll('.service-row').forEach(row => {
            const select = row.querySelector('.service-select');
            const quantityInput = row.querySelector('.quantity-input');
            const itemTotalInput = row.querySelector('.item-total');

            const selectedOption = select.options[select.selectedIndex];
            const cost = parseFloat(selectedOption.dataset.cost || 0);
            const quantity = parseInt(quantityInput.value || 1);

            const itemTotal = cost * quantity;
            itemTotalInput.value = itemTotal.toFixed(2);
            total += itemTotal;
        });

        document.getElementById('totalAmount').textContent = total.toFixed(2);
    }

    // Add first row on page load
    // Commented out - will only add when patient is selected
    // addServiceRow();
</script>

<style>
    /* Custom Select2 styling for better RTL support */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 48px;
        padding: 8px 12px;
        font-size: 1.125rem;
    }

    .select2-container--bootstrap-5 .select2-selection__rendered {
        line-height: 32px;
    }

    .select2-container--bootstrap-5 .select2-selection__arrow {
        height: 46px;
    }

    /* Highlight required field */
    #patientSelect + .select2-container {
        border: 2px solid #dee2e6;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out;
    }

    #patientSelect + .select2-container.select2-container--focus,
    #patientSelect + .select2-container.select2-container--open {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}